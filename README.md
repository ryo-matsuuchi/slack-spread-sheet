# Slack 経費精算ボット

Slack から経費情報を入力し、ユーザーごとの Google スプレッドシートに経費精算書を作成するボットです。

## 機能

### 経費登録機能

- 領収書添付での登録（メッセージアクション）
- 直接入力での登録（`/keihi`コマンド）
- スプレッドシートへの自動記録
- Google Drive での領収書管理（ユーザー別）

### 管理機能

- ユーザーごとのスプレッドシート設定
- 登録状況の確認
- 登録一覧の表示

## セットアップ

### 1. 管理用スプレッドシートの準備

1. 新しい Google スプレッドシートを作成
2. シート名を`user_settings`に変更
3. ヘッダー行を設定
   ```
   user_id | spreadsheet_id | email | created_at | updated_at
   ```
4. スプレッドシート ID を環境変数に設定

### 2. 環境変数の設定

```bash
cp .env.example .env
```

.env ファイルを編集：

```bash
# Slack App設定
SLACK_APP_TOKEN=xapp-...
SLACK_BOT_TOKEN=xoxb-...
SLACK_SIGNING_SECRET=...

# Google API設定
SETTINGS_SPREADSHEET_ID=... # 管理用スプレッドシートのID
GOOGLE_DRIVE_ROOT_FOLDER_ID=... # 領収書保存用フォルダのID

# アプリケーション設定
PORT=3000
NODE_ENV=development
```

### 3. 依存関係のインストール

```bash
npm install
```

### 4. アプリケーションの起動

```bash
npm start
```

## 使い方

### 初期設定（ユーザーごと）

1. 経費精算用の Google スプレッドシートを作成
2. `_base`シートを作成（テンプレート用）
   ```
   | No | 日付 | 金額 | 利用目的/内容 | 備考 |
   |----|------|------|---------------|------|
   | 1  |      |      |               |      |
   | 2  |      |      |               |      |
   ...
   | 25 |      |      |               |      |
   ```
3. アプリケーションのサービスアカウントに編集権限を付与
4. Slack で`/keihi setup [スプレッドシートID]`を実行

### 領収書添付での経費登録

1. Slack に領収書（PDF または画像）をアップロード
2. メッセージの「その他のアクション」から「経費精算書の作成」を選択
3. フォームに必要な情報を入力
   - 日付（任意、デフォルト：今日）
   - 金額（必須）
   - 利用目的/内容（任意）
   - 備考（任意）
4. 送信して完了

### 直接入力での経費登録

1. Slack で`/keihi`コマンドを実行
2. フォームに必要な情報を入力
   - 日付（任意、デフォルト：今日）
   - 金額（必須）
   - 利用目的/内容（任意）
   - 備考（任意）
3. 送信して完了

### コマンド一覧

- `/keihi setup [スプレッドシートID]` - スプレッドシートを設定
- `/keihi config` - 現在の設定を確認
- `/keihi` - 経費を登録（直接入力）
- `/keihi status [YYYY-MM]` - 登録状況を確認
- `/keihi list [YYYY-MM]` - 登録一覧を表示
- `/keihi help` - ヘルプを表示

## アーキテクチャ

```
[Slack]
   │
   ├── メッセージアクション ──┐
   │   (領収書添付)          │
   │                        │
   └── スラッシュコマンド ────┤
       (直接入力)           │
                           ▼
                    [Socket Mode]
                           │
                           ▼
                    [Node.jsサーバー]
                           │
               ┌──────────┴──────────┐
               │                     │
               ▼                     ▼
     [Google Drive]        [Googleスプレッドシート]
     (ユーザー別)           (ユーザー別)
```

## セキュリティ

- Socket Mode による安全な通信
- Slack 署名の検証
- API トークンによる認証
- ユーザー別の Google Drive アクセス権限
- セキュリティヘッダーの適用

## 開発

1. 開発サーバーの起動

   ```bash
   npm run dev
   ```

2. テストの実行
   ```bash
   npm test
   ```

## 今後の予定

- OCR 機能の実装（現在は無効化）
- 月次レポート機能の追加
- 一括登録機能の追加

## ライセンス

MIT
