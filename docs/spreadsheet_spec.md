# スプレッドシート仕様書

## シート構成

### ベースシート

- シート名: `_base`
- テンプレートとして使用
- 新規シート作成時にこのシートを複製

### 月次シート

- フォーマット: `YYYY_MM`（例：`2025_02`）
- 年月ごとに新しいシートを作成
- `_base`シートを複製して作成
- D3 セルに対象月の初日（例：2025/02/01）を入力

### シートテンプレート

各シートは以下の構造を持つ：

```
| No | 日付      | 金額   | 利用目的/内容 | 備考      |
|----|-----------|--------|---------------|-----------|
| 1  |           |        |               |           |
| 2  |           |        |               |           |
| ... |          |        |               |           |
| 25 |           |        |               |           |
```

- A 列: No（1 から 25 まで、あらかじめ入力済み）
- B 列: 日付（YYYY-MM-DD 形式）
- C 列: 金額（数値）
- D 列: 利用目的/内容（テキスト）
- E 列: 備考（テキスト、領収書 URL を含む）

### 特殊セル

- D3: 対象月の初日（YYYY/MM/DD 形式）
- C27: 合計金額（サマリーや一覧の取得コマンドで使用）

## データ更新ルール

### 新規シートの作成

1. `_base`シートの複製
2. シート名を`YYYY_MM`形式に設定
3. D3 セルに対象月の初日を入力

### 新規データの追加

1. 対象シートの検索

   - 日付から年月を抽出（例：2025-02-08 → 2025_02）
   - 該当シートが存在しない場合は新規作成

2. 空き行の検索

   - A 列に No が入力済みの行のうち
   - B 列〜E 列がすべて空の行を探す
   - 2 行目から 26 行目まで検索
   - 27 行目以降は使用しない

3. データの書き込み
   - B 列: 日付
   - C 列: 金額
   - D 列: 利用目的/内容
   - E 列: 備考 + 領収書 URL（改行区切り）

### エラー処理

1. 空き行なしの場合

   - エラーメッセージを返す
   - スプレッドシートの URL を含める

2. シート作成失敗の場合
   - エラーメッセージを返す
   - エラーの詳細をログに記録

## URL 生成

### スプレッドシート URL

- フォーマット: `https://docs.google.com/spreadsheets/d/{spreadsheetId}/edit#gid={sheetId}`
- spreadsheetId: 環境変数から取得
- sheetId: シート作成時に取得した ID

### 領収書 URL

- Google Drive の共有リンク
- アクセス権限:
  - ユーザーフォルダ: メールアドレスで権限設定（閲覧者）
  - 年月フォルダ: 親フォルダから権限を継承
  - 領収書ファイル: 親フォルダから権限を継承
- アクセス可能者: 該当ユーザーのみ
