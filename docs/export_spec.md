# PDF 出力機能仕様書

## コマンド仕様

### `/keihi export [YYYY-MM]`

- 年月を指定して PDF をエクスポート
- 年月省略時は当月を使用
- 例：`/keihi export 2025-02`

## 処理フロー

1. コマンド受信

   - 年月の妥当性チェック
   - シートの存在確認

2. スプレッドシートの PDF エクスポート

   - Google Sheets API を使用
   - 印刷設定
     - 用紙サイズ: A4
     - 向き: 縦
     - 余白: 標準
     - ヘッダー/フッター: なし

3. 領収書の取得と結合

   - 指定月の領収書を Google Drive から取得
   - PDF の場合：そのまま結合
   - 画像の場合：PDF に変換して結合
   - 結合順序：
     1. 経費精算書（1 ページ目）
     2. 領収書（日付順）

4. Google Drive への保存

   - 保存先: ユーザーの年月フォルダ
   - ファイル名: `経費精算書_YYYY_MM.pdf`
   - 既存ファイルがある場合は上書き

5. 完了通知
   - Slack にメッセージを送信
   - PDF へのリンクを含める
   - 結合した領収書の数を表示

## エラー処理

1. シートが存在しない場合

   - エラーメッセージ: "指定された年月のシートが見つかりません"
   - 作成方法の案内を含める

2. データが空の場合

   - エラーメッセージ: "出力するデータがありません"
   - シートの URL を含める

3. エクスポート失敗時

   - エラーメッセージ: "PDF の出力に失敗しました"
   - エラーの詳細をログに記録

4. 領収書の結合失敗時
   - エラーメッセージ: "領収書の結合に失敗しました"
   - 経費精算書の PDF のみを出力
   - エラーの詳細をログに記録

## 必要な権限

1. Google Sheets API

   - `https://www.googleapis.com/auth/spreadsheets.readonly`
   - `https://www.googleapis.com/auth/drive.file`

2. Google Drive API
   - `https://www.googleapis.com/auth/drive.file`

## 必要なパッケージ

1. PDF 関連

   - `pdf-lib`: PDF の作成・編集・結合
   - `sharp`: 画像処理（画像 →PDF 変換用）

2. Google API 関連
   - `googleapis`: 既存
   - `@google-cloud/vision`: 既存

## 実装手順

1. パッケージの追加

   ```bash
   npm install pdf-lib sharp
   ```

2. サービスの追加

   - `exportService.js`の作成
     - PDF エクスポート機能
     - 領収書取得機能
     - PDF 結合機能
     - Google Drive 保存機能

3. コマンドの追加

   - `slackService.js`に export コマンドを追加
   - パラメータのバリデーション実装
   - エラーハンドリングの実装

4. 設定の更新

   - API スコープの追加
   - 環境変数の追加（必要な場合）

5. ドキュメントの更新
   - README にコマンドの説明を追加
   - トラブルシューティングガイドの更新

## PDF 結合の仕様

1. 経費精算書（1 ページ目）

   - スプレッドシートから PDF としてエクスポート
   - A4 縦向き

2. 領収書（2 ページ目以降）

   - 指定月のフォルダから全ての領収書を取得
   - 日付でソート
   - PDF の場合：そのまま結合
   - 画像の場合：
     - A4 サイズに収まるように変換
     - 余白を追加
     - PDF に変換
   - ページ番号を追加（オプション）

3. しおり（Bookmarks）の追加
   - 1 ページ目: 経費精算書
   - 2 ページ目以降: 領収書（日付\_内容）
