# 経費精算書作成アプリケーション 設計書

## 1. 概要

Slack から経費情報を入力し、Google スプレッドシートに経費精算書を作成するアプリケーション。

## 2. 機能一覧

### 2.1 領収書添付での経費登録

1. **起動方法**

   - Slack で領収書（PDF または画像）をアップロード
   - メッセージの「その他のアクション」から「経費精算書の作成」を選択

2. **入力項目**

   - 日付（任意、デフォルト：今日の日付）
   - 金額（必須）
   - 利用目的/内容（任意）
   - 備考（任意）

3. **処理内容**
   - 領収書ファイルを Google Drive に保存
   - 経費情報をスプレッドシートに追加
   - 完了メッセージを送信（スプレッドシートと領収書へのリンクを含む）

### 2.2 直接入力での経費登録

1. **起動方法**

   - Slack で`/keihi`コマンドを実行

2. **入力項目**

   - 日付（任意、デフォルト：今日の日付）
   - 金額（必須）
   - 利用目的/内容（任意）
   - 備考（任意）

3. **処理内容**
   - 経費情報をスプレッドシートに追加
   - 完了メッセージを送信（スプレッドシートへのリンクを含む）

## 3. スプレッドシート仕様

### 3.1 シート構成

1. **ベースシート**

   - シート名: `_base`
   - 用途: 新規シート作成時のテンプレート
   - 初期設定: D3 セルに対象月の初日を設定

2. **月次シート**
   - シート名: `YYYY_MM`形式（例：`2025_02`）
   - 作成タイミング: 新しい年月の経費が登録される時
   - 作成方法: `_base`シートを複製

### 3.2 シート構造

1. **ヘッダー行**

   ```
   | No | 日付 | 金額 | 利用目的/内容 | 備考 |
   ```

2. **データ行**

   - A 列: No（1 から 25 まで、自動設定）
   - B 列: 日付（YYYY-MM-DD 形式）
   - C 列: 金額（数値）
   - D 列: 利用目的/内容（テキスト）
   - E 列: 備考（テキスト、領収書 URL を含む）

3. **特殊セル**
   - D3: 対象月の初日（YYYY/MM/DD 形式）
   - C27: 合計金額

## 4. Google Drive 仕様

### 4.1 フォルダ構造

```
ルート/
└── {ユーザーID}/
    └── YYYY-MM/
        └── 領収書ファイル
```

### 4.2 アクセス権限

1. **ユーザーフォルダ**

   - 作成時にユーザーのメールアドレスで権限を設定
   - 権限レベル: 閲覧者（reader）
   - 継承: 配下のフォルダとファイルに権限が継承される

2. **年月フォルダ**

   - 親フォルダ（ユーザーフォルダ）から権限を継承
   - 追加の権限設定なし

3. **領収書ファイル**
   - 親フォルダから権限を継承
   - アクセス可能者: 該当ユーザーのみ

### 4.3 ファイル管理

- ファイル名: 元のファイル名を保持
- 保存形式: オリジナルの形式（PDF または画像）を維持
- メタデータ: ID、WebViewLink（共有 URL）を保持

## 5. エラーハンドリング

### 5.1 入力値チェック

- 金額が未入力の場合はエラーメッセージを表示
- 内容が未入力の場合は「（内容なし）」を設定
- 備考が未入力の場合は空文字を設定

### 5.2 シート処理

- 空き行がない場合（26 行以上）はエラーメッセージを表示
- シート作成に失敗した場合はエラーメッセージを表示

### 5.3 ファイル処理

- ファイルのダウンロードに失敗した場合はエラーメッセージを表示
- Google Drive へのアップロードに失敗した場合はエラーメッセージを表示
- ユーザーのメールアドレス取得に失敗した場合はエラーメッセージを表示

## 6. 通知メッセージ

### 6.1 成功時

```
経費精算書を作成しました。
• 日付: YYYY-MM-DD
• 金額: ¥X,XXX
• 内容: XXXXX
• メモ: XXXXX

[スプレッドシートで開く] [領収書を確認]  // 領収書リンクは添付ありの場合のみ
```

### 6.2 エラー時

- 具体的なエラー内容を表示
- 再試行を促すメッセージを表示

## 7. 今後の拡張予定

### 7.1 OCR 機能

- 現在は無効化
- 将来的に Dify などの別サービスでの実装を検討
